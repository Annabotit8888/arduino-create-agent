<!DOCTYPE html>
<html>
	<head>
		<title>Arduino Create Agent - Debug</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	</head>
</html>
<body>
	<div class="container-fluid">
		<h1>Arduino Create Agent - Debug</h1>
	</div>
	<!-- Discovery -->
	<div class="container-fluid">
		<div class="row">
			<div class="col">
				<p><button class="btn btn-primary" onclick="discovery()">Discovery</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<pre id="discovery-req"></pre>
				</div>
			</div>
			<div class="col">
				<pre id="discovery-code"></pre>
			</div>
		</div>
	</div>
	<hr>
	<!-- Connect -->
	<div class="container-fluid">
		<div class="row">
			<div class="col">
				<div class="form-group">
					<label for="connect-port">Port</label>
					<input type="text" class="form-control" id="connect-port" required value="/dev/ttyACM0">
				</div>
			</div>
			<div class="col">
				<div class="form-group">
					<label for="connect-baud">Baud</label>
					<input type="number" class="form-control" id="connect-baud" placeholder="9600" value="9600">
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<p><button class="btn btn-primary" onclick="connect()">Connect</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<pre id="connect-req"></pre><br>
				<div id="connect-form" class="input-group" hidden=true>
					<input type="text" class="form-control" id="connect-msg" placeholder="" value="">
					<button class="btn btn-primary" onclick="send()">Send</button>
				</div>
			</div>
			<div class="col">
				<pre id="connect-code"></pre>
			</div>
		</div>
	</div>
	<hr>
	<!-- Tools -->
	<div class="container-fluid">
		<div class="row">
			<div class="col">
				<p><button class="btn btn-primary" onclick="tools()">Installed Tools</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<pre id="tools-req"></pre>
				</div>
			</div>
			<div class="col">
				<pre id="tools-code"></pre>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<label for="install-packager">Packager</label>
					<input type="text" class="form-control" id="install-packager" required value="arduino">
				</div>
			</div>
			<div class="col">
				<div class="form-group">
					<label for="install-name">Name</label>
					<input type="text" class="form-control" id="install-name" required value="avrdude">
				</div>
			</div>
			<div class="col">
				<div class="form-group">
					<label for="install-version">Version</label>
					<input type="text" class="form-control" id="install-version"value="latest">
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<p><button class="btn btn-primary" onclick="install()">Install</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<pre id="install-req"></pre>
				</div>
			</div>
			<div class="col">
				<pre id="install-code"></pre>
			</div>
		</div>
	</div>
	<hr>
	<!-- Upload -->
	<div class="container-fluid">
		<div class="row">
			<div class="col">
				<div class="form-group">
					<label for="upload-command">Command</label>
					<input type="text" class="form-control" id="upload-command" required value="upload:arduino:avr:leonardo">
				</div>
			</div>
			<div class="col">
				<div class="form-group">
					<label for="upload-port">Port</label>
					<input type="text" class="form-control" id="upload-port" required value="/dev/tty/ACM0">
				</div>
			</div>
			<div class="col">
				<div class="form-group">
					<label for="upload-sketch">Sketch</label>
					<input type="file" class="form-control" id="upload-sketch" required>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<p><button class="btn btn-primary" onclick="upload()">Upload</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<pre id="upload-req"></pre>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<label for="showupload-id">ID</label>
					<input type="text" class="form-control" id="showupload-id" required value="">
				</div>
			</div>

		</div>
		<div class="row">
			<div class="col">
				<p><button class="btn btn-primary" onclick="showupload()">Show Upload Result</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="form-group">
					<pre id="showupload-req"></pre>
				</div>
			</div>
			<div class="col">
				<div class="form-group">
					<pre id="showupload-code"></pre>
				</div>
			</div>
		</div>
	</div>

	<script>
var ws;

function connect() {
	var port = document.getElementById('connect-port').value;
	var baud = document.getElementById('connect-baud').value;

	var formEl = document.getElementById('connect-form');
	var codeEl = document.getElementById('connect-code');

	if (ws) {
		ws.onclose = function () {};
		ws.close();
	}

	codeEl.textContent = '';
	ws = new WebSocket("ws://"+ window.location.host +"/v1/connect?port=" + port + "&baud=" + baud);
	ws.onopen = function () {
		formEl.removeAttribute('hidden')
	}
	ws.onclose = function () {
		formEl.setAttribute('hidden', true)
		codeEl.textContent = codeEl.textContent + 'DISCONNECTED\n';
	}
	ws.onmessage = function (event) {
		console.debug(event.data)
		codeEl.textContent = codeEl.textContent + event.data + '\n';
	}
	ws.onerror = function (error) {
		console.error(error)
		codeEl.textContent = codeEl.textContent + 'ERROR\n';
	}

	var reqEl = document.getElementById('connect-req');
	reqEl.textContent = ws.url + '\n';
	reqEl.textContent = reqEl.textContent + '------------------------------------\n'
	console.debug(port, baud)
}

function send() {
	var msg = document.getElementById('connect-msg').value;
	ws.send(msg)
}

function discovery() {
	req('GET', '/v1/discover', 'discovery')
}

function tools() {
	req('GET', '/v1/tools', 'tools');
}

function install() {
	var packager = document.getElementById('install-packager').value;
	var name = document.getElementById('install-name').value;
	var version = document.getElementById('install-version').value;

	req('POST', '/v1/tools/' + packager + '/' + name + '/' + version, 'install');
}

function upload() {
	var sketch = document.getElementById('upload-sketch').files[0];
	var reader = new FileReader();
	reader.addEventListener("load", function () {
		var body = {
			command: document.getElementById('upload-command').value,
			port: document.getElementById('upload-port').value,
			filename: sketch.name,
			bin: reader.result
		}

		req('POST', '/v1/upload', 'upload', JSON.stringify(body))
			.then(function (response) {
				var id = response.headers.get('Location');
				var parts = id.split('/');
				document.getElementById('showupload-id').value = parts[parts.length-1];
			});
	}, false);

	reader.readAsDataURL(sketch);
}

function showupload() {
	var id = document.getElementById('showupload-id').value;
	req('GET', '/v1/upload/' + id, 'showupload');

}

function req(method, url, el, body) {
	var req = new Request(url, {
		method: method,
		body: body,
	});

	var reqEl = document.getElementById(el + '-req');
	reqEl.textContent = req.method + ' ' + req.url + '\n';
	reqEl.textContent = reqEl.textContent + '------------------------------------\n'

	var promise = fetch(req);

	promise.then(function(response) {
		reqEl.textContent = reqEl.textContent + 'STATUS ' + response.status + '\n';
		reqEl.textContent = reqEl.textContent + '------------------------------------\n\n'

		response.headers.forEach(function (value, name) {
			reqEl.textContent = reqEl.textContent + name + ': ' + value + '\n';
		})
		return response.json();
	}).then(function (response) {
		var codeEl = document.getElementById(el + '-code');
		codeEl.textContent = JSON.stringify(response, null, 2) + '\n';
	});

	return promise;
}
	</script>
</body>